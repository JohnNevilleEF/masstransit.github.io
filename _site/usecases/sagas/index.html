<!DOCTYPE html>
<html lang="en-us">

  <head>
  <!-- Canonical link to help search engines -->
  <link rel="canonical" href="/usecases/sagas/"/>

  <!-- Basic meta elements -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>

  <!--   Dublin Core metadata for Zotero -->
  <meta name="DC.title" content="track long running transactions? (sagas)" />
  <meta name="DC.creator" content="" />
  <meta name="DC.contributor" content="" />
  <meta name="DC.date" content="" />
  <meta name="DC.rights" content="" />
  <meta name="DC.source" content="MassTransit" />

    <!-- Open Graph metadata -->

    
    <meta property="og:title" content="track long running transactions? (sagas)"/>
    <meta property="og:description" content="Stuff">
    <meta property="fb:admins" content="elotroalex"/>
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://masstransit.io/usecases/sagas/"/>
    <meta property="fb:app_id" content="589495744558280"/>
    <meta property="og:image" content="http://masstransit.io/public/open-graph-logo.png"/>
    <meta property="og:image:width" content="200" />
    <meta property="og:image:height" content="200" />

    

  <title>
    
      track long running transactions? (sagas)
    
  </title>

  <!-- CSS links -->
  <link rel="stylesheet" href="/public/css/syntax.css"/>
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4.5.5/css/tachyons.min.css"/>
  <link rel="stylesheet" href="/public/css/mt.css"/>


  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/public/apple-touch-icon-precomposed.png"/>
  <link rel="shortcut icon" href="/public/favicon.png"/>

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"/>
</head>


  <body class="sans-serif bg-white">

    <div class="mw5 mw9-ns center pa3 ph5-ns">
      <h1 class="f2 fw7 ttu tracked lh-title mt0 mb3 avenir">
        <a href="/" title="Home">MassTransit</a>
        <br>
        <small>.Net Messaging</small>
      </h1>
    </div>
    <div class="mw5 mw9-ns center pa3 ph5-ns">
      <p>How to build long running transactions using a saga.</p>

<h2 id="using-sagas">Using Sagas</h2>

<p>The ability to ochestrate a series of events is a powerful feature, and MassTransit makes this possible.</p>

<p>A saga is a long-lived transaction managed by a coordinator. Sagas are initiated by an event, sagas orchestrate events, and sagas maintain the state of the overall transaction. Sagas are designed to manage the complexity of a distributed transaction without locking and immediate consistency. They manage state and track any compensations required if a partial failure occurs.</p>

<p>We didn’t create it, we learned it from the <a href="http://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf">original Cornell paper</a> and from Arnon Rotem-Gal-Oz’s <a href="http://www.rgoarchitects.com/Files/SOAPatterns/Saga.pdf">description</a>.</p>

<ul id="markdown-toc">
  <li><a href="#using-sagas" id="markdown-toc-using-sagas">Using Sagas</a></li>
  <li><a href="#creating-automatonymous-state-machines" id="markdown-toc-creating-automatonymous-state-machines">Creating Automatonymous State Machines</a>    <ul>
      <li><a href="#automatonymous-quick-start" id="markdown-toc-automatonymous-quick-start">Automatonymous Quick Start</a></li>
      <li><a href="#seriously" id="markdown-toc-seriously">Seriously?</a></li>
      <li><a href="#tracking-state" id="markdown-toc-tracking-state">Tracking State</a></li>
      <li><a href="#defining-behavior" id="markdown-toc-defining-behavior">Defining Behavior</a></li>
      <li><a href="#creating-instances" id="markdown-toc-creating-instances">Creating Instances</a></li>
      <li><a href="#creating-the-state-machine" id="markdown-toc-creating-the-state-machine">Creating the State Machine</a></li>
      <li><a href="#raising-events" id="markdown-toc-raising-events">Raising Events</a></li>
      <li><a href="#lifters" id="markdown-toc-lifters">Lifters</a></li>
    </ul>
  </li>
  <li><a href="#sample-state-machine" id="markdown-toc-sample-state-machine">Sample State Machine</a></li>
  <li><a href="#defining-a-state-machine-saga" id="markdown-toc-defining-a-state-machine-saga">Defining a state machine saga</a></li>
  <li><a href="#connecting-the-saga-to-a-receive-endpoint" id="markdown-toc-connecting-the-saga-to-a-receive-endpoint">Connecting the saga to a receive endpoint</a>    <ul>
      <li><a href="#combining-events-think-forkjoin" id="markdown-toc-combining-events-think-forkjoin">Combining events (think Fork/Join)</a></li>
    </ul>
  </li>
  <li><a href="#persisting-saga-instances" id="markdown-toc-persisting-saga-instances">Persisting Saga Instances</a>    <ul>
      <li><a href="#identity" id="markdown-toc-identity">Identity</a></li>
      <li><a href="#storage-engines" id="markdown-toc-storage-engines">Storage Engines</a>        <ul>
          <li><a href="#entity-framework" id="markdown-toc-entity-framework">Entity Framework</a></li>
          <li><a href="#mongodb" id="markdown-toc-mongodb">MongoDB</a></li>
          <li><a href="#nhibernate" id="markdown-toc-nhibernate">NHibernate</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="creating-automatonymous-state-machines">Creating Automatonymous State Machines</h2>

<p><a href="https://github.com/MassTransit/Automatonymous">Automatonymous</a> is a state machine library built by the same team that created MassTransit. Automatonymous provides a friendly syntax for declaring a state machine, including the states, events (both trigger event and data events are supported), and behaviors. The simple syntax makes it easy to get started with your own state machines, while including many advanced features that make it extremely flexible in a variety of business contexts.</p>

<p>Like MassTransit, Automatonymous is free, open source, and licensed under the very permissive Apache 2.0 license, making usable at no cost to anyone for both commercial and non-commercial use.</p>

<h3 id="automatonymous-quick-start">Automatonymous Quick Start</h3>

<p>So you’ve got the chops and want to get started quickly using Automatonymous. Maybe
you are a bad ass and can’t be bothered with reading documentation, or perhaps you
are already familiar with the Magnum StateMachine and want to see what things have
changed. Either way, here it is, your first state machine configured using Automatonymous.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">class</span> <span class="nc">Relationship</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">State</span> <span class="n">CurrentState</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">RelationshipStateMachine</span> <span class="p">:</span>
        <span class="n">MassTransitStateMachine</span><span class="p">&lt;</span><span class="n">Relationship</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">RelationshipStateMachine</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Event</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Hello</span><span class="p">);</span>
            <span class="nf">Event</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">PissOff</span><span class="p">);</span>
            <span class="nf">Event</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Introduce</span><span class="p">);</span>

            <span class="nf">State</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Friend</span><span class="p">);</span>
            <span class="nf">State</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Enemy</span><span class="p">);</span>

            <span class="nf">Initially</span><span class="p">(</span>
                <span class="nf">When</span><span class="p">(</span><span class="n">Hello</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">TransitionTo</span><span class="p">(</span><span class="n">Friend</span><span class="p">),</span>
                <span class="nf">When</span><span class="p">(</span><span class="n">PissOff</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">TransitionTo</span><span class="p">(</span><span class="n">Enemy</span><span class="p">),</span>
                <span class="nf">When</span><span class="p">(</span><span class="n">Introduce</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">Then</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">TransitionTo</span><span class="p">(</span><span class="n">Friend</span><span class="p">)</span>                   
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">State</span> <span class="n">Friend</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">State</span> <span class="n">Enemy</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="n">Event</span> <span class="n">Hello</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">Event</span> <span class="n">PissOff</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">Introduce</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Person</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

<h3 id="seriously">Seriously?</h3>

<p>Okay, so two classes are defined above, one that represents the state (<code class="highlighter-rouge">Relationship</code>)
and the other that defines the behavior of the state machine (<code class="highlighter-rouge">RelationshipStateMachine</code>).
For each state machine that is defined, it is expected that there will be at least one instance.
In Automatonymous, state is separate from behavior, allowing many instances to be managed using
a single state machine.</p>

<div class="w100 br3 hidden ba b--lightest-blue mv4"><div class="f4 black-60 bg-lightest-blue pv2 ph3 mv0 br3 br--top">Note</div><div class="f5 lh-copy measure pa3">For some object-oriented purists, this may be causing the hair to raise on the back of your neck. Chill out, it's not the end of the world here. If you have a penchant for encapsulating behavior with data (practices such as domain model, DDD, etc.), recognize that programming language constructs are the only thing in your way here.</div></div>

<h3 id="tracking-state">Tracking State</h3>

<p>State is managed in Automatonymous using a class, shown above as the <code class="highlighter-rouge">Relationship</code>.</p>

<h3 id="defining-behavior">Defining Behavior</h3>

<p>Behavior is defined using a class that inherits from <code class="highlighter-rouge">MassTransitStateMachine</code>. The class is generic,
and the state type associated with the behavior must be specified. This allows the state machine configuration
to use the state for a better configuration experience.</p>

<div class="w100 br3 hidden ba b--lightest-blue mv4"><div class="f4 black-60 bg-lightest-blue pv2 ph3 mv0 br3 br--top">Note</div><div class="f5 lh-copy measure pa3">It also makes Intellisense work better.</div></div>

<p>States are defined in the state machine as properties. They are initialized by default, so there is no need
to declare them explicitly unless they are somehow special, such as a Substate or Superstate.</p>

<div class="w100 br3 hidden ba b--lightest-blue mv4"><div class="f4 black-60 bg-lightest-blue pv2 ph3 mv0 br3 br--top">Note</div><div class="f5 lh-copy measure pa3">Configuration of a state machine is done using an internal DSL, using an approach known as Object Scoping, and is explained in Martin Fowler's Domain Specific Languages book.</div></div>

<h3 id="creating-instances">Creating Instances</h3>

<p>tbd</p>

<h3 id="creating-the-state-machine">Creating the State Machine</h3>

<p>tbd</p>

<h3 id="raising-events">Raising Events</h3>

<p>Once a state machine and an instance have been created, it is necessary to raise an event on the state
machine instance to invoke some behavior. There are three or four participants involved in raising an event: a
state machine, a state machine instance, and an event. If the event includes data, the data for the event is also
included.</p>

<p>The most explicit way to raise an event is shown below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="kt">var</span> <span class="n">relationship</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Relationship</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">machine</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RelationshipStateMachine</span><span class="p">();</span>

    <span class="k">await</span> <span class="n">machine</span><span class="p">.</span><span class="nf">RaiseEvent</span><span class="p">(</span><span class="n">relationship</span><span class="p">,</span> <span class="n">machine</span><span class="p">.</span><span class="n">Hello</span><span class="p">);</span></code></pre></figure>

<p>If the event has data, it is passed along with the event as shown.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="kt">var</span> <span class="n">person</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Person</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"Joe"</span> <span class="p">};</span>

    <span class="k">await</span> <span class="n">machine</span><span class="p">.</span><span class="nf">RaiseEvent</span><span class="p">(</span><span class="n">relationship</span><span class="p">,</span> <span class="n">machine</span><span class="p">.</span><span class="n">Introduce</span><span class="p">,</span> <span class="n">person</span><span class="p">);</span></code></pre></figure>

<h3 id="lifters">Lifters</h3>

<p>Lifters allow events to be raised without knowing explicit details about the state machine or the instance type,
making it easier to raise events from objects that do not have prior type knowledge about the state machine or the instance. Using an approach known as <em>currying</em> (from functional programming), individual arguments of raising an event can be removed.</p>

<p>For example, using an event lift, the state machine is removed.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="kt">var</span> <span class="n">eventLift</span> <span class="p">=</span> <span class="n">machine</span><span class="p">.</span><span class="nf">CreateEventLift</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">Hello</span><span class="p">);</span>

    <span class="c1">// elsewhere in the code, the lift can be used    
</span>    <span class="k">await</span> <span class="n">eventLift</span><span class="p">.</span><span class="nf">Raise</span><span class="p">(</span><span class="n">relationship</span><span class="p">);</span></code></pre></figure>

<p>The instance can also be lifted, making it possible to raise an event without any instance type knowledge.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="kt">var</span> <span class="n">instanceLift</span> <span class="p">=</span> <span class="n">machine</span><span class="p">.</span><span class="nf">CreateInstanceLift</span><span class="p">(</span><span class="n">relationship</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">helloEvent</span> <span class="p">=</span> <span class="n">machine</span><span class="p">.</span><span class="n">Hello</span><span class="p">;</span>

    <span class="c1">// elsewhere in the code, the lift can be used
</span>    <span class="k">await</span> <span class="n">instanceLift</span><span class="p">.</span><span class="nf">Raise</span><span class="p">(</span><span class="n">helloEvent</span><span class="p">);</span></code></pre></figure>

<p>Lifts are commonly used by plumbing code to avoid dynamic methods or delegates, making code
clean and fast.</p>

<h2 id="sample-state-machine">Sample State Machine</h2>

<p>The following code will require installing a few NuGet dependencies.</p>

<ul>
  <li><code class="highlighter-rouge">MassTransit</code></li>
  <li><code class="highlighter-rouge">Automatonymous</code></li>
  <li><code class="highlighter-rouge">MassTransit.Automatonymous</code></li>
</ul>

<h2 id="defining-a-state-machine-saga">Defining a state machine saga</h2>

<p>To define a state machine saga, create a class that inherits from <code class="highlighter-rouge">MassTransitStateMachine</code>. The <code class="highlighter-rouge">MassTransit.Automatonymous</code> NuGet package
must be referenced.</p>

<div class="w100 br3 hidden ba b--lightest-blue mv4"><div class="f4 black-60 bg-lightest-blue pv2 ph3 mv0 br3 br--top">Note</div><div class="f5 lh-copy measure pa3">This section is written using the shopping cart sample, which is [hosted on GitHub](https://github.com/MassTransit/Sample-ShoppingWeb).</div></div>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">public</span> <span class="k">class</span> <span class="nc">ShoppingCartStateMachine</span> <span class="p">:</span>
        <span class="n">MassTransitStateMachine</span><span class="p">&lt;</span><span class="n">ShoppingCart</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">ShoppingCartStateMachine</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">InstanceState</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CurrentState</span><span class="p">);</span></code></pre></figure>

<p>The state machine class, and the specification of the property for the current state of the machine are defined first.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">        <span class="nf">Event</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">ItemAdded</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">CorrelateBy</span><span class="p">(</span><span class="n">cart</span> <span class="p">=&gt;</span> <span class="n">cart</span><span class="p">.</span><span class="n">UserName</span><span class="p">,</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">UserName</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">SelectId</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">()));</span></code></pre></figure>

<p>The event that is observed when an item is added to the cart, along with the correlation between the state machine instance and the message are defined. The id generator for the saga instance is also defined.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">        <span class="nf">Event</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Submitted</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">CorrelateById</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">CartId</span><span class="p">));</span></code></pre></figure>

<p>The order submitted event, and the correlation for that order.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">        <span class="nf">Schedule</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">CartExpired</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ExpirationId</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">x</span><span class="p">.</span><span class="n">Delay</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
            <span class="n">x</span><span class="p">.</span><span class="n">Received</span> <span class="p">=</span> <span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="nf">CorrelateById</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">CartId</span><span class="p">);</span>
        <span class="p">});</span></code></pre></figure>

<p>In order to schedule the timeout, a schedule is defined, including the time delay for the scheduled event, and the correlation of the event back to the state machine.</p>

<p>Now, it is time for the actual behavior of the events and how they interact with the state of the <em>ShoppingCart</em>.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">        <span class="nf">Initially</span><span class="p">(</span>
            <span class="nf">When</span><span class="p">(</span><span class="n">ItemAdded</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Then</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Created</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">;</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Updated</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">;</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">UserName</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">UserName</span><span class="p">;</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nf">ThenAsync</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">Out</span><span class="p">.</span><span class="nf">WriteLineAsync</span><span class="p">(</span><span class="err">$</span><span class="s">"Item Added: {context.Data.UserName} to {context.Instance.CorrelationId}"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Schedule</span><span class="p">(</span><span class="n">CartExpired</span><span class="p">,</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">CartExpiredEvent</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">TransitionTo</span><span class="p">(</span><span class="n">Active</span><span class="p">)</span>
            <span class="p">);</span></code></pre></figure>

<p>Initially defined events that can create a state machine instance. In the above, the properties of the instance are initialized, and then the <em>CartExpired</em> event is scheduled, after which the state is set to <em>Active</em>.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="nf">During</span><span class="p">(</span><span class="n">Active</span><span class="p">,</span>
        <span class="nf">When</span><span class="p">(</span><span class="n">Submitted</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Then</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Timestamp</span> <span class="p">&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Updated</span><span class="p">)</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Updated</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">;</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">OrderId</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">OrderId</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nf">ThenAsync</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">Out</span><span class="p">.</span><span class="nf">WriteLineAsync</span><span class="p">(</span><span class="err">$</span><span class="s">"Cart Submitted: {context.Data.UserName} to {context.Instance.CorrelationId}"</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">Unschedule</span><span class="p">(</span><span class="n">CartExpired</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">TransitionTo</span><span class="p">(</span><span class="n">Ordered</span><span class="p">),</span></code></pre></figure>

<p>While the shopping cart is active, if the order is submitted, the expiration is canceled (via <em>Unschedule</em>) and the state is set to Ordered.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">        <span class="nf">When</span><span class="p">(</span><span class="n">ItemAdded</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Then</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Timestamp</span> <span class="p">&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Updated</span><span class="p">)</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Updated</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nf">ThenAsync</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">Out</span><span class="p">.</span><span class="nf">WriteLineAsync</span><span class="p">(</span><span class="err">$</span><span class="s">"Item Added: {context.Data.UserName} to {context.Instance.CorrelationId}"</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">Schedule</span><span class="p">(</span><span class="n">CartExpired</span><span class="p">,</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">CartExpiredEvent</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">)),</span></code></pre></figure>

<p>If another item is added to the cart, the <em>CartExpired</em> event is scheduled, and the existence of a previously scheduled event (via the <em>ExpirationId</em> property) is used to cancel the previously scheduled event.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">        <span class="nf">When</span><span class="p">(</span><span class="n">CartExpired</span><span class="p">.</span><span class="n">Received</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">ThenAsync</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">Out</span><span class="p">.</span><span class="nf">WriteLineAsync</span><span class="p">(</span><span class="err">$</span><span class="s">"Item Expired: {context.Instance.CorrelationId}"</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">CartRemovedEvent</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Instance</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">Finalize</span><span class="p">()</span>
        <span class="p">);</span></code></pre></figure>

<p>If the <em>CartExpired</em> event is received, the cart removed event is published and the shopping cart is finalized.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">            <span class="nf">SetCompletedWhenFinalized</span><span class="p">();</span>
        <span class="p">}</span></code></pre></figure>

<p>Signals that the state machine instance should be deleted if it is finalized. This is used to tell Entity Framework to delete the row from the database.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">public</span> <span class="n">State</span> <span class="n">Active</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">State</span> <span class="n">Ordered</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></code></pre></figure>

<p>The states of the shopping cart (<em>Initial</em> and <em>Final</em> are built-in states).</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">public</span> <span class="n">Schedule</span><span class="p">&lt;</span><span class="n">ShoppingCart</span><span class="p">,</span> <span class="n">CartExpired</span><span class="p">&gt;</span> <span class="n">CartExpired</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></code></pre></figure>

<p>The schedule definition for the CartExpired event.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">public</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">CartItemAdded</span><span class="p">&gt;</span> <span class="n">ItemAdded</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">OrderSubmitted</span><span class="p">&gt;</span> <span class="n">Submitted</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The events that are observed by the state machine (the correlations are defined earlier in the state machine).</p>

<p>The state machine is generic, and requires a state class (because sagas are stateful), so that is defined below. The state class has the values
that are persisted between events.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">class</span> <span class="nc">ShoppingCartState</span> <span class="p">:</span>
    <span class="n">SagaStateMachineInstance</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">CorrelationId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></code></pre></figure>

<p>The CorrelationId is the primary key of the saga state instance. It is assigned either from a property on the initial message that creates
the saga instance, or can be generated using <code class="highlighter-rouge">NewId.NextGuid()</code>, which ensures a nice ordered sequential identifier.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">public</span> <span class="kt">string</span> <span class="n">CurrentState</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></code></pre></figure>

<p>The current state of the saga, which can be saved as a <em>string</em> or an <em>int</em>, depending upon your database requirements. An <em>int</em> is smaller,
but requires that all valid states be mapped to integers during the definition of the state machine.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">public</span> <span class="n">Guid</span><span class="p">?</span> <span class="n">ExpirationId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></code></pre></figure>

<p>This is an identifier that is used by the state machine’s scheduling feature, to capture the scheduled message identifier. Message scheduling within
sagas is a powerful feature, which is described later.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">public</span> <span class="kt">string</span> <span class="n">UserName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">Created</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">Updated</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>


    <span class="k">public</span> <span class="n">Guid</span><span class="p">?</span> <span class="n">OrderId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The remainder of the properites are relevant to the application, and are saved when properly mapped using the saga repository (which can be any supported
storage engine, Entity Framework and NHibernate are supported out of the box).</p>

<h2 id="connecting-the-saga-to-a-receive-endpoint">Connecting the saga to a receive endpoint</h2>

<p>To connect the state machine saga to a receive endpoint, a saga repository is used, along with the state machine instance.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="kt">var</span> <span class="n">repository</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InMemorySagaRepository</span><span class="p">&lt;</span><span class="n">ShoppingCartState</span><span class="p">&gt;();</span>

<span class="n">_busControl</span> <span class="p">=</span> <span class="n">Bus</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">CreateUsingRabbitMq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">IRabbitMqHost</span> <span class="n">host</span> <span class="p">=</span> <span class="n">x</span><span class="p">.</span><span class="nf">Host</span><span class="p">(...);</span>
    <span class="n">x</span><span class="p">.</span><span class="nf">ReceiveEndpoint</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="s">"shopping_cart_state"</span><span class="p">,</span> <span class="n">e</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">e</span><span class="p">.</span><span class="n">PrefetchCount</span> <span class="p">=</span> <span class="m">8</span><span class="p">;</span>
        <span class="n">e</span><span class="p">.</span><span class="nf">StateMachineSaga</span><span class="p">(</span><span class="n">_machine</span><span class="p">,</span> <span class="n">repository</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="n">x</span><span class="p">.</span><span class="nf">UseInMemoryMessageScheduler</span><span class="p">();</span> <span class="c1">// for testing, to make it easy
</span><span class="p">});</span></code></pre></figure>

<h3 id="combining-events-think-forkjoin">Combining events (think Fork/Join)</h3>

<p>Multiple events can be combined into a single event, for the purposes of joining together multiple operations. To define a combined event, the <code class="highlighter-rouge">Event</code> syntax has an overload.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">OrderReady</span><span class="p">&gt;</span> <span class="n">Ready</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="k">public</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">PaymentApproved</span><span class="p">&gt;</span> <span class="n">Approved</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="k">public</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">StockVerified</span><span class="p">&gt;</span> <span class="n">Verified</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

<span class="nf">CompositeEvent</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">OrderReady</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">OrderReadyStatus</span><span class="p">,</span> <span class="n">PaymentApproved</span><span class="p">,</span> <span class="n">StockVerified</span><span class="p">);</span></code></pre></figure>

<p>Once both events have been delivered to the state machine, the third event, <em>OrderReady</em>, will be triggered.</p>

<div class="w100 br3 hidden ba b--lightest-blue mv4"><div class="f4 black-60 bg-lightest-blue pv2 ph3 mv0 br3 br--top">Note</div><div class="f5 lh-copy measure pa3">The order of events being declared can impact the order in which they execute. Therefore, it is best to declare composite events at the end of the state machine declaration, after all other events and behaviors are declared. That way, the composite events will be raised *after* the dependent event behaviors.</div></div>

<h2 id="persisting-saga-instances">Persisting Saga Instances</h2>

<p>Sagas are stateful event-based message consumers – they retain state. Therefore, saving state between events is important. Without persistent state, a saga would consider each event a new event, and orchestration of subsequent events would be meaningless.</p>

<h3 id="identity">Identity</h3>

<p>Saga instances are identified by a unique identifier (<code class="highlighter-rouge">Guid</code>), represented by the <code class="highlighter-rouge">CorrelationId</code> on the saga instance. Events are correlated to the saga instance using either the unique identifier, or alternatively using an expression that correlates properties on the saga instance to each event. If the <code class="highlighter-rouge">CorrelationId</code> is used, it’s always a one-to-one match, either the saga already exists, or it’s a new saga instance. With a correlation expression, the expression might match to more than one saga instance, so care should be used – because the event would be delivered to all matching instances.</p>

<div class="w100 br3 hidden ba b--washed-red mv4"><div class="f4 black-60 bg-washed-red pv2 ph3 mv0 br3 br--top">Heads Up!</div><div class="f5 lh-copy measure pa3">Seriously, don't sent an event to all instances -- unless you want to watch your messages consumers lock your entire saga storage engine.</div></div>

<h3 id="storage-engines">Storage Engines</h3>

<p>MassTransit supports several storage engines, including NHibernate, Entity Framework, and MongoDB. Each of these are setup in a similar way, but examples are shown below for each engine.</p>

<h4 id="entity-framework">Entity Framework</h4>

<p>Entity Framework seems to be the most common ORM for class-SQL mappings, and SQL is still widely used for storing data. So it’s a win to have it supported out of the box by MassTransit. The code-first mapping example below shows the basics of getting started.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">SagaInstance</span> <span class="p">:</span>
    <span class="n">SagaStateMachineInstance</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">SagaInstance</span><span class="p">(</span><span class="n">Guid</span> <span class="n">correlationId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">CorrelationId</span> <span class="p">=</span> <span class="n">correlationId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="nf">SagaInstance</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">CurrentState</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">ServiceName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">CorrelationId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>


<span class="k">public</span> <span class="k">class</span> <span class="nc">SagaInstanceMap</span> <span class="p">:</span>
    <span class="n">SagaClassMapping</span><span class="p">&lt;</span><span class="n">SagaInstance</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">SagaInstanceMap</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CurrentState</span><span class="p">);</span>
        <span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ServiceName</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Length</span><span class="p">(</span><span class="m">40</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The repository is then created on the context factory for the <code class="highlighter-rouge">DbContext</code> is available.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">SagaDbContextFactory</span> <span class="n">contextFactory</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
    <span class="k">new</span> <span class="n">SagaDbContext</span><span class="p">&lt;</span><span class="n">SagaInstance</span><span class="p">,</span> <span class="n">SagaInstanceMap</span><span class="p">&gt;(</span><span class="n">_connectionString</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">repository</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EntityFrameworkSagaRepository</span><span class="p">&lt;</span><span class="n">SagaInstance</span><span class="p">&gt;(</span><span class="n">contextFactory</span><span class="p">);</span></code></pre></figure>

<h4 id="mongodb">MongoDB</h4>

<p>MongoDB is an easy to use saga repository, because setup is easy. There is no need for class mapping, the saga instances can be persisted easily using a MongoDB collection.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">SagaInstance</span> <span class="p">:</span>
    <span class="n">SagaStateMachineInstance</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">SagaInstance</span><span class="p">(</span><span class="n">Guid</span> <span class="n">correlationId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">CorrelationId</span> <span class="p">=</span> <span class="n">correlationId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="nf">SagaInstance</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">CurrentState</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">ServiceName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">CorrelationId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The saga repository is created using the simple syntax:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="kt">var</span> <span class="n">database</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MongoClient</span><span class="p">(</span><span class="s">"mongodb://127.0.0.1"</span><span class="p">).</span><span class="nf">GetDatabase</span><span class="p">(</span><span class="s">"sagas"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">repository</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MongoDbSagaRepository</span><span class="p">&lt;</span><span class="n">SagaInstance</span><span class="p">&gt;(</span><span class="n">database</span><span class="p">);</span></code></pre></figure>

<p>Each saga instance will be placed in a collection specific to the instance type.</p>

<h4 id="nhibernate">NHibernate</h4>

<p>While the project seems dead, NHibernate is still widely used and is supported by MassTransit for saga storage. The example below shows the code-first approach to using NHibernate for saga persistence.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">SagaInstance</span> <span class="p">:</span>
    <span class="n">SagaStateMachineInstance</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">SagaInstance</span><span class="p">(</span><span class="n">Guid</span> <span class="n">correlationId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">CorrelationId</span> <span class="p">=</span> <span class="n">correlationId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="nf">SagaInstance</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">CurrentState</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">ServiceName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">CorrelationId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>


<span class="k">public</span> <span class="k">class</span> <span class="nc">SagaInstanceMap</span> <span class="p">:</span>
    <span class="n">SagaClassMapping</span><span class="p">&lt;</span><span class="n">SagaInstance</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">SagaInstanceMap</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CurrentState</span><span class="p">);</span>
        <span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ServiceName</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Length</span><span class="p">(</span><span class="m">40</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The <code class="highlighter-rouge">SagaClassMapping</code> base class maps the <code class="highlighter-rouge">CorrelationId</code> of the saga, and handles some of the basic bootstrapping of the class map. All of the properties, including the property for the <code class="highlighter-rouge">CurrentState</code> (if you’re using state machine sagas), must be mapped by the developer. Once mapped, the <code class="highlighter-rouge">ISessionFactory</code> can be created using NHibernate directly. From the session factory, the saga repository can be created.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">ISessionFactory</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="nf">CreateSessionFactory</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">repository</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NHibernateSagaRepository</span><span class="p">&lt;</span><span class="n">SagaInstance</span><span class="p">&gt;(</span><span class="n">sessionFactory</span><span class="p">);</span></code></pre></figure>


    </div>

    <script>

    // Highlight search Query
    var url = window.location.href;
      if (url.lastIndexOf("?q=") > 0) {
        // get the index of the parameter, add three (to account for length)
        var stringloc = url.lastIndexOf("?q=") + 3;
        // get the substring (query) and decode
        var searchquery = decodeURIComponent(url.substr(stringloc));
        // regex matches at beginning of line, end of line or word boundary, useful for poetry
        var regex = new RegExp("(?:^|\\b)(" + searchquery + ")(?:$|\\b)", "gim");
        // get, add mark and then set content
        var content = document.getElementById("main").innerHTML;
        document.getElementById("main").innerHTML = content.replace(regex, "<mark>$1</mark>");
      }

    // Toggle sidebar
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
    <!-- Facebook SDK for JavaScript -->
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '589495744558280',
      xfbml      : true,
      version    : 'v2.6'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>
  </body>
</html>
