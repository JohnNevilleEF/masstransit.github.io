<!DOCTYPE html>
<html lang="en-us">

  <head>
  <!-- Canonical link to help search engines -->
  <link rel="canonical" href="/usecases/courier/"/>

  <!-- Basic meta elements -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>

  <!--   Dublin Core metadata for Zotero -->
  <meta name="DC.title" content="orchestrate multiple services? (courier)" />
  <meta name="DC.creator" content="" />
  <meta name="DC.contributor" content="" />
  <meta name="DC.date" content="" />
  <meta name="DC.rights" content="" />
  <meta name="DC.source" content="MassTransit" />

    <!-- Open Graph metadata -->

    
    <meta property="og:title" content="orchestrate multiple services? (courier)"/>
    <meta property="og:description" content="Stuff">
    <meta property="fb:admins" content="elotroalex"/>
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://masstransit.io/usecases/courier/"/>
    <meta property="fb:app_id" content="589495744558280"/>
    <meta property="og:image" content="http://masstransit.io/public/open-graph-logo.png"/>
    <meta property="og:image:width" content="200" />
    <meta property="og:image:height" content="200" />

    

  <title>
    
      orchestrate multiple services? (courier)
    
  </title>

  <!-- CSS links -->
  <link rel="stylesheet" href="/public/css/syntax.css"/>
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4.5.5/css/tachyons.min.css"/>
  <link rel="stylesheet" href="/public/css/mt.css"/>


  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/public/apple-touch-icon-precomposed.png"/>
  <link rel="shortcut icon" href="/public/favicon.png"/>

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"/>
</head>


  <body class="sans-serif bg-white">

    <div class="mw5 mw9-ns center pa3 ph5-ns">
      <h1 class="f2 fw7 ttu tracked lh-title mt0 mb3 avenir">
        <a href="/" title="Home">MassTransit</a>
        <br>
        <small>.Net Messaging</small>
      </h1>
    </div>
    <div class="mw5 mw9-ns center pa3 ph5-ns">
      <p>How to connect many services into one flow.</p>

<h2 id="using-courier">Using Courier</h2>

<p>Developing applications using a distributed, message-based architecture significantly increases the complexity of performing operations transactionally, where an end-to-end set of steps much be completed entirely, or not at all. In an application using an ACID database, this is typically done using SQL transactions, where partial operations are rolled back if the transaction cannot be completed. However, this doesn’t scale when the steps being to include dependencies outside of a single database. And in the distributed, <em>micro-services</em> based architectures, the use of a single ACID database is shrinking to completely non-existent.</p>

<p>MassTransit Courier is a mechanism for creating and executing distributed transactions with fault compensation that can be used to meet the requirements previously within the domain of database transactions, but built to scale across a large system of distributed services. Courier also works well with MassTransit sagas, which add transaction monitoring and recoverability.</p>

<ul id="markdown-toc">
  <li><a href="#using-courier" id="markdown-toc-using-courier">Using Courier</a></li>
  <li><a href="#using-a-routing-slip" id="markdown-toc-using-a-routing-slip">Using a Routing Slip</a></li>
  <li><a href="#masstransit-courier" id="markdown-toc-masstransit-courier">MassTransit Courier</a></li>
  <li><a href="#activities" id="markdown-toc-activities">Activities</a>    <ul>
      <li><a href="#execute-activities" id="markdown-toc-execute-activities">Execute Activities</a></li>
      <li><a href="#implementing-an-activity" id="markdown-toc-implementing-an-activity">Implementing an activity</a></li>
      <li><a href="#compensating-an-activity" id="markdown-toc-compensating-an-activity">Compensating an activity</a></li>
    </ul>
  </li>
  <li><a href="#building-a-routing-slip" id="markdown-toc-building-a-routing-slip">Building a routing slip</a></li>
  <li><a href="#executing-the-routing-slip" id="markdown-toc-executing-the-routing-slip">Executing the routing slip</a></li>
  <li><a href="#monitoring-routing-slip-execution" id="markdown-toc-monitoring-routing-slip-execution">Monitoring routing slip execution</a></li>
  <li><a href="#subscriptions" id="markdown-toc-subscriptions">Subscriptions</a>    <ul>
      <li><a href="#custom-events" id="markdown-toc-custom-events">Custom events</a></li>
    </ul>
  </li>
</ul>

<h2 id="using-a-routing-slip">Using a Routing Slip</h2>

<p>A routing slip specifies a sequence of processing steps called <em>activities</em> that are combined into a single transaction. As each activity completes, the routing slip is forwarded to the next activity in the itinerary. When all activities have completed, the routing slip is completed and the transaction is complete.</p>

<p>A key advantage to using a routing slip is it allows the activities to vary for each transaction. Depending upon the requirements for each transaction, which may differ based on things like payment methods, billing or shipping address, or customer preference ratings, the routing slip builder can selectively add activities to the routing slip. This dynamic behavior is in contrast to a more explicit behavior defined by a state machine or sequential workflow that is statically defined (either through the use of code, a DSL, or something like Windows Workflow).</p>

<h2 id="masstransit-courier">MassTransit Courier</h2>

<p>MassTransit Courier is a framework that implements the routing slip pattern. Leveraging a durable messaging transport and the advanced saga features of MassTransit, Courier provides a powerful set of components to simplify the use of routing slips in distributed applications. Combining the routing slip pattern with a <a href="https://github.com/phatboyg/Automatonymous">state machine such as Automatonymous</a> results in a reliable, recoverable, and supportable approach for coordinating and monitoring message processing across multiple services.</p>

<p>In addition to the basic routing slip pattern, MassTransit Courier also supports <a href="http://en.wikipedia.org/wiki/Compensation_%28engineering%29">compensations</a> which allow activities to store execution data so that reversible operations can be undone, using either a traditional rollback mechanism or by applying an offsetting operation. For example, an activity that holds a seat for a patron could release the held seat when compensated.</p>

<h2 id="activities">Activities</h2>

<p>In MassTransit Courier, an <em>Activity</em> refers to a processing step that can be added to a routing slip. To create an activity, create a class that implements the <em>Activity</em> interface.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadImageActivity</span> <span class="p">:</span>
    <span class="n">Activity</span><span class="p">&lt;</span><span class="n">DownloadImageArguments</span><span class="p">,</span> <span class="n">DownloadImageLog</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">ExecuteResult</span><span class="p">&gt;</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">ExecutionContext</span><span class="p">&lt;</span><span class="n">DownloadImageArguments</span><span class="p">&gt;</span> <span class="n">context</span><span class="p">);</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">CompensationResult</span><span class="p">&gt;</span> <span class="nf">Compensate</span><span class="p">(</span><span class="n">CompensateContext</span><span class="p">&lt;</span><span class="n">DownloadImageLog</span><span class="p">&gt;</span> <span class="n">context</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The <em>Activity</em> interface is generic with two arguments. The first argument specifies the activity’s input type and the second argument specifies the activity’s log type. In the example shown above, <em>DownloadImageArguments</em> is the input type and <em>DownloadImageLog</em> is the log type. Both arguments must be interface types so that the implementations can be dynamically created.</p>

<h3 id="execute-activities">Execute Activities</h3>

<p>An <em>Execute Activity</em> is an activity that only executes and does not support compensation. As such, the definition of a log type is not required.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">ValidateImageActivity</span> <span class="p">:</span>
    <span class="n">ExecuteActivity</span><span class="p">&lt;</span><span class="n">ValidateImageArguments</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">ExecuteResult</span><span class="p">&gt;</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">ExecutionContext</span><span class="p">&lt;</span><span class="n">DownloadImageArguments</span><span class="p">&gt;</span> <span class="n">context</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<h3 id="implementing-an-activity">Implementing an activity</h3>

<p>An activity must implement two interface methods, <em>Execute</em> and <em>Compensate</em>. The <em>Execute</em> method is called while the routing slip is executing activities and the <em>Compensate</em> method is called when a routing slip faults and needs to be compensated.</p>

<p>When the <em>Execute</em> method is called, an <em>execution</em> argument is passed containing the activity arguments, the routing slip <em>TrackingNumber</em>, and methods to mark the activity as completed or faulted. The actual routing slip message, as well as any details of the underlying infrastructure, are excluded from the <em>execution</em> argument to prevent coupling between the activity and the implementation. An example <em>Execute</em> method is shown below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">  <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ExecutionResult</span><span class="p">&gt;</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">Execution</span><span class="p">&lt;</span><span class="n">DownloadImageArguments</span><span class="p">&gt;</span> <span class="n">execution</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">DownloadImageArguments</span> <span class="n">args</span> <span class="p">=</span> <span class="n">execution</span><span class="p">.</span><span class="n">Arguments</span><span class="p">;</span>
      <span class="kt">string</span> <span class="n">imageSavePath</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">WorkPath</span><span class="p">,</span>
          <span class="n">execution</span><span class="p">.</span><span class="n">TrackingNumber</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>

      <span class="k">await</span> <span class="n">_httpClient</span><span class="p">.</span><span class="nf">GetAndSave</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ImageUri</span><span class="p">,</span> <span class="n">imageSavePath</span><span class="p">);</span>

      <span class="k">return</span> <span class="k">await</span> <span class="n">execution</span><span class="p">.</span><span class="nf">Completed</span><span class="p">(</span><span class="k">new</span> <span class="nf">DownloadImageLogImpl</span><span class="p">(</span><span class="n">imageSavePath</span><span class="p">));</span>
  <span class="p">}</span></code></pre></figure>

<p>Once activity processing is complete, the activity returns an <em>ExecutionResult</em> to the host. If the activity executes successfully, the activity can elect to store compensation data in an activity log which is passed to the <em>Completed</em> method on the <em>execution</em> argument. If the activity chooses not to store any compensation data, the activity log argument is not required. In addition to compensation data, the activity can add or modify variables stored in the routing slip for use by subsequent activities.</p>

<div class="w100 br3 hidden ba b--lightest-blue mv4"><div class="f4 black-60 bg-lightest-blue pv2 ph3 mv0 br3 br--top">Note</div><div class="f5 lh-copy measure pa3">In the example above, the activity creates an instance of a private class that implements the *DownloadImageLog* interface and stores the log information in the object properties. The object is then passed to the *Completed* method for storage in the routing slip before sending the routing slip to the next activity.</div></div>

<h3 id="compensating-an-activity">Compensating an activity</h3>

<p>When an activity fails, the <em>Compensate</em> method is called for previously executed activities in the routing slip that stored compensation data. If an activity does not store any compensation data, the <em>Compensate</em> method is never called. The compensation method for the example above is shown below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">Task</span><span class="p">&lt;</span><span class="n">CompensationResult</span><span class="p">&gt;</span> <span class="nf">Compensate</span><span class="p">(</span><span class="n">Compensation</span><span class="p">&lt;</span><span class="n">DownloadImageLog</span><span class="p">&gt;</span> <span class="n">compensation</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DownloadImageLog</span> <span class="n">log</span> <span class="p">=</span> <span class="n">compensation</span><span class="p">.</span><span class="n">Log</span><span class="p">;</span>
    <span class="n">File</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="n">ImageSavePath</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">compensation</span><span class="p">.</span><span class="nf">Compensated</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Using the activity log data, the activity compensates by removing the downloaded image from the work directory. Once the activity has compensated the previous execution, it returns a <em>CompensationResult</em> by calling the <em>Compensated</em> method. If the compensating actions could not be performed (either via logic or an exception) and the inability to compensate results in a failure state, the <em>Failed</em> method can be used instead, optionally specifying an <em>Exception</em>.</p>

<h2 id="building-a-routing-slip">Building a routing slip</h2>

<p>Developers are discouraged from directly implementing the <em>RoutingSlip</em> message type and should instead use a <em>RoutingSlipBuilder</em> to create a routing slip. The <em>RoutingSlipBuilder</em> encapsulates the creation of the routing slip and includes methods to add activities, activity logs, and variables to the routing slip. For example, to create a routing slip with two activities and an additional variable, a developer would write:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RoutingSlipBuilder</span><span class="p">(</span><span class="n">NewId</span><span class="p">.</span><span class="nf">NextGuid</span><span class="p">());</span>
<span class="n">builder</span><span class="p">.</span><span class="nf">AddActivity</span><span class="p">(</span><span class="s">"DownloadImage"</span><span class="p">,</span> <span class="s">"rabbitmq://localhost/execute_downloadimage"</span><span class="p">,</span> <span class="k">new</span>
    <span class="p">{</span>
        <span class="n">ImageUri</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"http://images.google.com/someImage.jpg"</span><span class="p">)</span>
    <span class="p">});</span>
<span class="n">builder</span><span class="p">.</span><span class="nf">AddActivity</span><span class="p">(</span><span class="s">"FilterImage"</span><span class="p">,</span> <span class="s">"rabbitmq://localhost/execute_filterimage"</span><span class="p">);</span>
<span class="n">builder</span><span class="p">.</span><span class="nf">AddVariable</span><span class="p">(</span><span class="s">"WorkPath"</span><span class="p">,</span> <span class="s">"\\dfs\work"</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">routingSlip</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span></code></pre></figure>

<p>Each activity requires a name for display purposes and a URI specifying the execution address. The execution address is where the routing slip should be sent to execute the activity. For each activity, arguments can be specified that are stored and presented to the activity via the activity arguments interface type specify by the first argument of the <em>Activity</em> interface. The activities added to the routing slip are combined into an <em>Itinerary</em>, which is the list of activities to be executed, and stored in the routing slip.</p>

<div class="w100 br3 hidden ba b--lightest-blue mv4"><div class="f4 black-60 bg-lightest-blue pv2 ph3 mv0 br3 br--top">Note</div><div class="f5 lh-copy measure pa3">Managing the inventory of available activities, as well as their names and execution addresses, is the responsibility of the application and is not part of the MassTransit Courier. Since activities are application specific, and the business logic to determine which activities to execute and in what order is part of the application domain, the details are left to the application developer.</div></div>

<h2 id="executing-the-routing-slip">Executing the routing slip</h2>

<p>Once built, the routing slip is executed, which sends it to the first activity’s execute URI. To make it easy and to ensure that source information is included, an extension method on <em>IBus</em> is available, the usage of which is shown below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">await</span> <span class="n">bus</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">routingSlip</span><span class="p">);</span></code></pre></figure>

<p>It should be pointed out that if the address for the first activity is invalid or cannot be reached, an exception will be thrown by the <em>Execute</em> method.</p>

<h2 id="monitoring-routing-slip-execution">Monitoring routing slip execution</h2>

<p>During routing slip execution, events are published when the routing slip completes or faults. Every event message includes the <em>TrackingNumber</em> as well as a <em>Timestamp</em> (in UTC, of course) indicating when the event occurred:</p>

<ul>
  <li>RoutingSlipCompleted</li>
  <li>RoutingSlipFaulted</li>
  <li>RoutingSlipCompensationFailed</li>
</ul>

<p>Additional events are published for each activity, including:</p>

<ul>
  <li>RoutingSlipActivityCompleted</li>
  <li>RoutingSlipActivityFaulted</li>
  <li>RoutingSlipActivityCompensated</li>
  <li>RoutingSlipActivityCompensationFailed</li>
</ul>

<p>By observing these events, an application can monitor and track the state of a routing slip. To maintain the current state, an Automatonymous state machine could be created. To maintain history, events could be stored in a database and then queried using the <em>TrackingNumber</em> of the routing slip.</p>

<h2 id="subscriptions">Subscriptions</h2>

<p>By default, routing slip events are published – which means that any subscribed consumers will receive the events. While this is useful getting started, it can quickly get out of control as applications grow and multiple unrelated routing slips are used. To handle this, subscriptions were added (yes, added, because they weren’t though of until we experienced this ourselves).</p>

<p>Subscriptions are added to the routing slip at the time it is built using the <code class="highlighter-rouge">RoutingSlipBuilder</code>.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">builder</span><span class="p">.</span><span class="nf">AddSubscription</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"rabbitmq://localhost/log-events"</span><span class="p">),</span> <span class="n">RoutingSlipEvents</span><span class="p">.</span><span class="n">All</span><span class="p">);</span></code></pre></figure>

<p>This subscription would send all routing slip events to the specified endpoint. If the application only wanted specified events, the events can be selected by specifying the enumeration values for those events. For example, to only get the <code class="highlighter-rouge">RoutingSlipCompleted</code> and <code class="highlighter-rouge">RoutingSlipFaulted</code> events, the following code would be used.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">builder</span><span class="p">.</span><span class="nf">AddSubscription</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"rabbitmq://localhost/log-events"</span><span class="p">),</span> <span class="n">RoutingSlipEvents</span><span class="p">.</span><span class="n">Completed</span> <span class="p">|</span> <span class="n">RoutingSlipEvents</span><span class="p">.</span><span class="n">Faulted</span><span class="p">);</span></code></pre></figure>

<p>It is also possible to tweak the content of the events to cut down on message size. For instance, by default, the <code class="highlighter-rouge">RoutingSlipCompleted</code> event includes the variables from the routing slip. If the variables contained a large document, that document would be copied to the event. Eliminating the variables from the event would reduce the message size, thereby reducing the traffic on the message broker. To specify the contents of a routing slip event subscription, an additional argument is specified.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">builder</span><span class="p">.</span><span class="nf">AddSubscription</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"rabbitmq://localhost/log-events"</span><span class="p">),</span> <span class="n">RoutingSlipEvents</span><span class="p">.</span><span class="n">Completed</span><span class="p">,</span> <span class="n">RoutingSlipEventContents</span><span class="p">.</span><span class="n">None</span><span class="p">);</span></code></pre></figure>

<p>This would send the <code class="highlighter-rouge">RoutingSlipCompleted</code> event to the endpoint, without any of the variables be included (only the main properties of the event would be present).</p>

<div class="w100 br3 hidden ba b--lightest-blue mv4"><div class="f4 black-60 bg-lightest-blue pv2 ph3 mv0 br3 br--top">Note</div><div class="f5 lh-copy measure pa3">Once a subscription is added to a routing slip, events are no longer published -- they are only sent to the addresses specified in the subscriptions. However, multiple subscriptions can be specified -- the endpoints just need to be known at the time the routing slip is built.</div></div>

<h3 id="custom-events">Custom events</h3>

<p>It is also possible to specify a subscription with a custom event, a message that is created by the application developer. This makes it possible to create your own event types and publish them in response to routing slip events occurring. And this includes having the full context of a regular endpoint <code class="highlighter-rouge">Send</code> so that any headers or context settings can be applied.</p>

<p>To create a custom event subscription, use the overload shown below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="c1">// first, define the event type in your assembly
</span><span class="k">public</span> <span class="k">interface</span> <span class="n">OrderProcessingCompleted</span>
<span class="p">{</span>
    <span class="n">Guid</span> <span class="n">TrackingNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">DateTime</span> <span class="n">Timestamp</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">string</span> <span class="n">OrderId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">string</span> <span class="n">OrderApproval</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// then, add the subscription with the custom properties
</span><span class="n">builder</span><span class="p">.</span><span class="nf">AddSubscription</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"rabbitmq://localhost/order-events"</span><span class="p">),</span> <span class="n">RoutingSlipEvents</span><span class="p">.</span><span class="n">Completed</span><span class="p">,</span>
    <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Send</span><span class="p">&lt;</span><span class="n">OrderProcessingCompleted</span><span class="p">&gt;(</span><span class="k">new</span>
    <span class="p">{</span>
        <span class="n">OrderId</span> <span class="p">=</span> <span class="s">"BFG-9000"</span><span class="p">,</span>
        <span class="n">OrderApproval</span> <span class="p">=</span> <span class="s">"ComeGetSome"</span>
    <span class="p">}));</span></code></pre></figure>

<p>In the message contract above, there are four properties, but only two of them are specified. By default, the base <code class="highlighter-rouge">RoutingSlipCompleted</code> event is created, and then the content of that event is <em>merged</em> into the message created in the subscription. This ensures that the dynamic values, such as the <code class="highlighter-rouge">TrackingNumber</code> and the <code class="highlighter-rouge">Timestamp</code>, which are present in the default event, are available in the custom event.</p>

<p>Custom events can also select with contents are merged with the custom event, using an additional method overload.</p>

    </div>

    <script>

    // Highlight search Query
    var url = window.location.href;
      if (url.lastIndexOf("?q=") > 0) {
        // get the index of the parameter, add three (to account for length)
        var stringloc = url.lastIndexOf("?q=") + 3;
        // get the substring (query) and decode
        var searchquery = decodeURIComponent(url.substr(stringloc));
        // regex matches at beginning of line, end of line or word boundary, useful for poetry
        var regex = new RegExp("(?:^|\\b)(" + searchquery + ")(?:$|\\b)", "gim");
        // get, add mark and then set content
        var content = document.getElementById("main").innerHTML;
        document.getElementById("main").innerHTML = content.replace(regex, "<mark>$1</mark>");
      }

    // Toggle sidebar
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
    <!-- Facebook SDK for JavaScript -->
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '589495744558280',
      xfbml      : true,
      version    : 'v2.6'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>
  </body>
</html>
